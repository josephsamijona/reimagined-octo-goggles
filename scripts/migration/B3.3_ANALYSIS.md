# Analyse B.3.3: Mise √† Jour des URLs en Base de Donn√©es

## Contexte
Apr√®s migration B2 ‚Üí S3, nous devons v√©rifier si les r√©f√©rences de fichiers en base de donn√©es n√©cessitent une mise √† jour.

## Champs Identifi√©s

### 1. Documents (`app/models/documents.py`)
- `InterpreterContractSignature.contract_document` ‚Üí `upload_to='interpreter_contracts/'`
- `InterpreterContractSignature.signature_image` ‚Üí `upload_to='signatures/'`
- `Document.file` ‚Üí `upload_to='documents/%Y/%m/'`
- `SignedDocument.original_document` ‚Üí `upload_to=pdf_upload_path` (fonction)
- `SignedDocument.signed_document` ‚Üí `upload_to=pdf_upload_path`
- `SignedDocument.signature_image` ‚Üí `upload_to=signature_upload_path` (fonction)

### 2. Finance (`app/models/finance.py`)
- `ClientPayment.payment_proof` ‚Üí `upload_to='payment_proofs/'`
- `InterpreterPayment.payment_proof` ‚Üí `upload_to='interpreter_payment_proofs/'`
- `Expense.receipt` ‚Üí `upload_to='expense_receipts/'`
- `Reimbursement.receipt` ‚Üí `upload_to='receipts/'`
- `CompanyInfo.company_logo` ‚Üí `upload_to='company_logos/'`

### 3. Users (`app/models/users.py`)
- `Interpreter.profile_image` ‚Üí `upload_to='interpreter_profiles/'`

## Comportement Django FileField

**Point Critique:** Django `FileField` stocke **uniquement le chemin relatif** (ex: `signatures/signature_abc123.png`), PAS l'URL compl√®te.

Lorsque vous appelez `.url`, Django:
1. Prend le chemin relatif stock√© en DB
2. Utilise le `Storage` backend configur√© (`STORAGES['default']`)
3. G√©n√®re l'URL compl√®te dynamiquement

## Impact du Changement de Storage

### Avant (B2):
```python
# settings.py
STORAGES = {"default": {"BACKEND": "custom_storages.MediaStorage"}}  # B2 backend
# custom_storages.py (ancien)
class MediaStorage:  # B2 API
    bucket_name = 'jhbridgestockagesystem'
```

### Apr√®s (S3):
```python
# settings.py
STORAGES = {"default": {"BACKEND": "custom_storages.MediaStorage"}}  # S3 backend
# custom_storages.py (nouveau)
class MediaStorage(S3Boto3Storage):
    bucket_name = 'jhbridge-documents-prod'
    location = 'media'
```

## Probl√®me Potentiel: Pr√©fixe `media/`

**Attention:** Notre nouveau `MediaStorage` a `location = 'media'`.

Cela signifie que:
- Chemin en DB: `signatures/signature_abc.png`
- Chemin S3 r√©el: `media/signatures/signature_abc.png`

**Mais nos fichiers migr√©s sont √†:**
- `media/signatures/signature_abc.png` ‚úÖ (Correct si migr√© depuis B2 avec pr√©fixe)
- OU `signatures/signature_abc.png` ‚ùå (Si le pr√©fixe n'√©tait pas dans B2)

## V√©rifications N√©cessaires

### 1. V√©rifier Structure B2 Originale
Ex√©cuter un script pour lister quelques fichiers et voir leur structure:
```python
# Exemple de chemin B2 original ?
# √âtait-ce: "media/signatures/..." ou "signatures/..." ?
```

### 2. V√©rifier Chemins en Base de Donn√©es
```sql
SELECT file FROM app_document LIMIT 5;
SELECT signature_image FROM app_interpretercontractsignature WHERE signature_image IS NOT NULL LIMIT 5;
```

## Sc√©narios et Actions

### Sc√©nario A: Chemins en DB SANS pr√©fixe `media/`
**Exemple DB:** `signatures/sig_123.png`
**Fichier S3:** `media/signatures/sig_123.png`

**Action:** ‚úÖ **AUCUNE** - Le `location='media'` dans `MediaStorage` ajoutera automatiquement le pr√©fixe.

### Sc√©nario B: Chemins en DB AVEC pr√©fixe `media/`
**Exemple DB:** `media/signatures/sig_123.png`
**Fichier S3:** `media/signatures/sig_123.png`

**Action:** ‚ö†Ô∏è **PROBL√àME** - Django ajoutera `media/` en double ‚Üí `media/media/signatures/...`

**Solution:** Retirer `location='media'` de `MediaStorage` OU nettoyer les chemins en DB.

### Sc√©nario C: URLs Absolues en DB (Rare)
**Exemple DB:** `https://jhbridgestockagesystem.s3.backblazeb2.com/media/signatures/sig.png`

**Action:** üî¥ **CRITIQUE** - Remplacer par chemins relatifs.

## Recommandations

1. **Ex√©cuter script de diagnostic** (cr√©√© ci-dessous)
2. **V√©rifier √©chantillon de fichiers** en DB vs S3
3. **Ajuster `location` dans `custom_storages.py`** si n√©cessaire
4. **NE PAS ex√©cuter de UPDATE massif** avant validation manuelle

## Script de Diagnostic

Voir: `scripts/migration/diagnose_file_paths.py`
